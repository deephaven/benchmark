# Copyright (c) 2024-2024 Deephaven Data Labs and Patent Pending

# Run the Benchmark release process that results in publishing a 
# deephaven-benchmark jar to maven central and a distro tar file to 
# the Github release notes as an asset

name: Publish Deephaven Benchmark

on:
  workflow_dispatch:
    inputs:
     version:
       description: 'Deephaven Community Version'
       required: true
       default: '0.36.0'
       type: string
     release-commit:
       description: 'Benchmark Release Commit Hash'
       required: true
       default: '849d7e99a873ad6ff1ccd6c1a5099d33f8393f1a'
       type: string
     previous-commit:
       description: 'Benchmark Previous Commit or Tag'
       required: true
       default: 'v0.35.0'
       type: string
     mark-latest:
       description: 'Mark as Latest'
       required: true
       default: true
       type: boolean
       
env:
  TAG_NAME: "v${{inputs.version}}"
  VERSION: "${{inputs.version}}"

jobs:
  build:

    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Start Deephaven and Supporting Containers
      run: |
        cp .github/resources/integration-docker-compose.yml docker-compose.yml
        docker compose up -d

    - name: Build with Maven
      run: |
        mvn -B verify --file pom.xml
        docker compose down 
      
    - name: Build Release Distro and Notes
      run: .github/scripts/make-release-distro.sh ${VERSION}
      
    - name: Test Release Distro
      run: .github/scripts/test-release-distro.sh ${VERSION} 
      
    - name: Archive Results
      uses: actions/upload-artifact@v4
      with:
        name: Deephaven Benchmark Release
        path: |
          target/deephaven-benchmark-${VERSION}.tar
          target/deephaven-benchmark-${VERSION}-results.tar
          
    - name: Publish Github Release
      uses: ncipollo/release-action@v1
      with:
        commit: ${{ inputs.tag-commit }}
        allowUpdates: true
        artifacts: target/deephaven-benchmark-${env.VERSION}.tar"
        bodyFile: "release-body.md"
          

